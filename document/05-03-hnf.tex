When we defined what a refinement is, we saw that some terms had refinements and other did not.
But it was not clear what was the reason behind that.

In this section we will see that terms that can be refined are exactly the terms
that have a normal form.

\begin{definition}[Head normal forms]
A term $\tm \in \terms$ of the lambda-calculus is a \defn{head normal form}
if it is of the form:
%there exist an integer $n \geq 0$, a sequence of $n$ variables $\var_1,\hdots,\var_n$,
%a variable $\vartwo$,
%an integer $m \geq 0$, and a sequence of $m$ terms $\tm_1,\hdots,\tm_m \in \terms$ such that:
\[
  \tm = \lam{\var_1}{\hdots\lam{\var_n}{\vartwo\,\tm_1\,\hdots\,\tm_m}}
\]
Note that $\vartwo$ might be or not be among the $\var_1,\hdots,\var_n$.
Similarly, a term $\tm \in \termsdist$ of the distributive lambda-calculus is a \defn{head normal form}
if it is of the form:
%there exist an integer $n \geq 0$,
%labels $\lab_1,\hdots,\lab_n$,
%variables $\var_1,\hdots,\var_n$,
%a variable $\vartwo$, a type $\typ$,
%an integer $m \geq 0$, and a sequence of $m$ lists of terms $\ls{\tm}_1,\hdots,\ls{\tm}_m \in \ls{\termsdist}$
%such that:
\[
  \tm = \lamp{\lab_1}{\var_1}{\hdots\lamp{\lab_n}{\var_n}{\vartwo^{\typ}\,\ls{\tm}_1\,\hdots\,\ls{\tm}_m}}
\]
\end{definition}

This is coherent with the fact that typability in system~$\mathcal{W}$ characterizes
head normalization.


\begin{lemma}
\llem{hnf_iff_distnf}
Let $\tm \in \terms$ and $\tm' \in \termsdist$ such that $\tm \refinedby  \tm'$.
Then $\tm$ is in head normal form if and only if $\tm'$ is in head normal form.
\end{lemma}
\begin{proof}
  We will do each direction separately.
\begin{itemize}
  \item[]{\bf $\Rightarrow$.}
    We proceed by induction on $\tm$.
    \begin{enumerate}
    \item \Case{Variable, $\tm = \vartwo$}
      Then $\tm'$ is necessarily $\vartwo^\typ$.
    \item \Case{Abstraction, $\tm = \lam{\var_1}{\tmthree}$}
      In this case, as $\tm'$ refines $\tm$, $\tm' = \lamp{\lab}{\var_1}{\tmthree'}$,
        where $\tmthree' \refines \tmthree$.
      Note that $\tmthree$ is in head normal form, so by inductive hypothesis we get that $\tmthree'$ is too.
        Then $\tm'$ is in head normal form.
    \item \Case{Application, $\tm = \tmthree \tmfour$}
      Here, $\tm' = \tmthree' [\tmfour'_1, ..., \tmfour'_n]$,
        where $\tmthree'$ refines $\tmthree$, and $\tmfour'_i$ refines $\tmfour$ for every $i$.


      Note that as $\tm$ is in head normal form, then $\tmthree$ also is,
        because it is of the form $\vartwo \tm_1 \hdots \tm_m$.
        Then, by inductive hypothesis, we know that $\tmthree'$ is in head normal form, too.
        Furthermore, because of the
        shape that $\tmthree$ has, we know $\tmthree'$ does not have a lambda at the root
        (because if it had it would not refine $\tmthree$).
        So $\tmthree' = \vartwo \ls{\tm}_1 \hdots \ls{\tm}_m$ (with $m$ potentially $0$).

      All this allows us to arrive at the conclusion that
        $\vartwo \ls{\tm}_1 \hdots \ls{\tm}_m [\tmfour'_1, ..., \tmfour'_n]$, \ie $\tm'$, is in head normal form.
    \end{enumerate}

  \item[]{\bf $\Leftarrow$.} Analogous to $\Rightarrow$.
\end{itemize}
\end{proof}


\begin{lemma}
\TODO{Arreglar o cambiar esta demo.}
\llem{hnf_has_refinement}
Let $\tm \in \terms$ such that it is in head normal form.
 Then there exists $\tm' \in \termsdist$ such that $\tm \refinedby \tm'$.
\end{lemma}
\begin{proof}
Suppose $\tm \in \terms$ is in head normal form.
Then $\tm = \lam{\var_1}{\hdots\lam{\var_n}{\vartwo\,\tm_1\,\hdots\,\tm_m}}$.

We will prove that there exists a correct $\tctx \vdash \tm' : \typtwo$ such that $\tm' \refines \tm$.

To make the proof easier, we are going to prove something stronger:
  \begin{itemize}
    \item that there exists such $\tm'$,
    \item that for every application in $\tm'$ the argument list is empty, and
    \item that if $\var_i = \vartwo$ for any $i$, $\tctx$ will be empty,
      otherwise it will be a singleton of the form $\set{\vartwo : [\typ]}$.
  \end{itemize}

We proceed by induction on the pair $(n, m)$, that is, by induction on
  $\mathbb{N}^2$ with lexicographic order.

\begin{enumerate}
  \item {\bf Base $(0, 0)$.} In this case $\tm = \vartwo$,
    so we can simply choose $\tm'$ to be $\vartwo^\typ$.
  \item {\bf Inductive step.} We want to see that the property holds for
    $(n, m) > (0,0)$ given that it holds for all $(n', m') < (n, m)$.
    Here there are two cases, either $n = 0$ or $n > 0$.
    \begin{enumerate}
      \item {\bf $n = 0$.} We have that $\tm = \vartwo\,\tm_1\,\hdots\,\tm_m$, $m \geq 1$.
        Let $\tmtwo = \vartwo\,\tm_1\,\hdots\,\tm_{m-1}$.
        By inductive hypothesis, there exists a correct term $\tmtwo'$ that
          refines $\tmtwo$.

        We can suppose, without loss of generality, that
          $\tmtwo' = \vartwo^\typ\,\ls{\tm}_1\,\hdots\,\ls{\tm}_{m-1}$,
        where each element of $\ls{\tm}_i$ refines $\tm_i$.
        If $\tmtwo'$ wasn't like that, it simply would not refine $\tmtwo$.
        If $m = 1$, then $\tmtwo' = \vartwo$ and the type of $\vartwo$ is $\typ_1$.

        If $m > 1$, the inductive hypothesis tells us that all $\ls{\tm}_i$ are empty, so
          $\tmtwo' = \vartwo \emptylset_1 \hdots \emptylset_{m-1}$
          (we number them to make it more clear which is which).
        Because of Unique typing, the type of $\vartwo$ has to be
          $\emptylset_1 \to \hdots \to \emptylset_{m-1} \to \typ_1$,
        where $\typ_1$ is the type of $\tmtwo'$.
        Diagramatically,
        \[
          \indrule{\toE}{
            \set{\vartwo : \emptylset_1 \to \hdots \to \emptylset_{m-1} \to \typ_1}
              \vdash
              \vartwo^{\emptylset_1 \to \hdots \to \emptylset_{m-1} \to \typ_1}
                \,\emptylset_1\,\hdots\,\emptylset_{m-2}
              : \emptylset_{m-1} \to \typ_1
          }{
            \set{\vartwo : \emptylset_1 \to \hdots \to \emptylset_{m-1} \to \typ_1}
              \vdash \vartwo^{\emptylset_1 \to \hdots \to \emptylset_{m-1} \to \typ_1}
                \,\emptylset_1\,\hdots\,\emptylset_{m-1}
              : \typ_1
          }
        \]
        Now, we can give a typing derivation for the following term,
          if we consider a derivation very similar to the last one but
          where $\typ_1$ has been replaced by $\emptylset \to \typ_2$.
        \[
          \indrule{\toE}{
            \set{\vartwo : \emptylset_1 \to \hdots \to \emptylset_{m-1} \to \emptylset \to \typ_2}
              \vdash \vartwo^{\emptylset_1 \to \hdots \to \emptylset_{m-1} \to \emptylset \to \typ_2}
                \,\emptylset_1\,\hdots\,\emptylset_{m-1}
              : \emptylset \to \typ_2
          }{
            \set{\vartwo : \emptylset_1 \to \hdots \to \emptylset_{m-1} \to \emptylset \to \typ_2} \vdash \vartwo^{\emptylset_1 \to \hdots \to \emptylset_{m-1} \to \emptylset \to \typ_2}\,\emptylset_1\,\hdots\,\emptylset_{m-1}\,\emptylset : \typ_2
          }
        \]
        Let $\tm' = \vartwo^{\emptylset_1 \to \hdots \to \emptylset_{m-1} \to \emptylset \to \typ_2}\,\emptylset_1\,\hdots\,\emptylset_{m-1}\,\emptylset$.

        Note that the derivation fo $\tm'$ can be completed very easily in the
          same way that $\tmtwo'$ was done, and it's easy to check that $\tm'$
          is correct (contexts are sequential, there are no lambdas, and types
          are sequential, because the derivation is essentially the same that
          the one of $\tmtwo'$).
        Moreover, $\tm'$ refines $\tm$, so we are done.
      \item {\bf $n > 0$.} We have that $\tm = \lam{\var_1}{\hdots\lam{\var_n}{\vartwo\,\tm_1\,\hdots\,\tm_m}}$.
        Let $\tmtwo = \lam{\var_2}{\hdots\lam{\var_n}{\vartwo\,\tm_1\,\hdots\,\tm_m}}$.
        By inductive hypothesis, there is a term $\tctx \vdash \tmtwo' : \typ$ that refines $\tmtwo$.
        The same way as before, we know that
          $\tmtwo' = \lamp{\lab_2}{\var_2}{\hdots\lamp{\lab_n}{\var_n}{\vartwo\,\emptylset\,\hdots\,\emptylset}}$.

        Let $\tm' = \lamp{\lab}{\var_1}{\tmtwo'}$, where $\lab$ is fresh.
        \TODO{gonza: If $\var_1 = \vartwo$ and $\var_1 \neq \var_i$ for all $1 < i \leq n$,
          then $\lab$ is the external label of $\vartwo$, and in any other case it is a fresh label.}
        Here to make the proof tidier we will divide in two new cases,
          depending on whether $\var_1 = \vartwo$ and $\var_1 \neq \var_i$ for all $1 < i \leq n$, or not.
        \begin{enumerate}
          \item {\bf $\var_1 = \vartwo$ and $\var_1 \neq \var_i$ for all $1 < i \leq n$.}
            In this case, by inductive hypothesis $\tctx$ must be a singleton $\set{y : \typ_1}$.
            \[
              \indrule{\toI}{
                \set{\vartwo : \typ_1} \vdash \tmtwo' : \typ
              }{
                \emptyset \vdash \lamp{\lab}{\var_1}{\tmtwo'} : [\typ_1] \tolab{\lab} \typ
              }
            \]
            We have that $\tm' \refines \tm$, and that the derivation of $\tm'$ has sequential types and contexts,
              because by inductive hypothesis $\tmtwo'$ does.
            Finally, $\tm'$ has pairwise distinct labels in all lambdas because $\tmtwo'$ does and $\lab$
              was chosen to be a fresh label.
            \item {\bf $\var_1 \neq \vartwo$ or $x_1 = x_i$ for some $1 < i \leq n$.}
            \[
              \indrule{\toI}{
                \set{\vartwo : \typ_1} \vdash \tmtwo' : \typ
              }{
                \set{\vartwo : \typ_1} \vdash \lamp{\lab}{\var_1}{\tmtwo'} : \emptylset \tolab{\lab} \typ
              }
            \]
            Like in the previous case, we have that $\tm' \refines \tm$, and that the derivation of
              $\tm'$ has sequential types and contexts, because by inductive hypothesis
              $\tmtwo'$ does, and that $\tm'$ has pairwise distinct labels in all lambdas
              because $\tmtwo'$ does and $\lab$ was chosen to be a fresh label.
        \end{enumerate}
    \end{enumerate}
\end{enumerate}
\end{proof}


\begin{lemma}[Backwards simulation]
\TODO{Arreglar o cambiar demo o lema}
\llem{backwards_simulation}
Let $\tm,\tmtwo \in \terms$ be lambda-terms and $\tmtwo' \in \termsdist$ be a distributive term such that:

\[
\xymatrix@C=1cm{
 \tm \ar[r]^{\beta} & \tmtwo \ar@{}[d]|*=0[@]{\rtimes} \\
                    & \tmtwo' \\
}
\]

Then there exists a term $\tm' \in \termsdist$ such that
\[
\xymatrix@C=1cm{
 \tm \ar@{}[d]|*=0[@]{\rtimes} \ar[r]^{\beta} & \tmtwo \ar@{}[d]|*=0[@]{\rtimes} \\
 \tm' \ar@{.>>}[r]^{\dist} & \tmtwo' \\
}
\]
Moreover, the proof is constructive.
\end{lemma}
\begin{proof}
By induction on $\tm$.
\begin{enumerate}
\item {\bf Variable (same), $\tm = \var$.} This case cannot happen, as $\tm$ has no redexes.
\item {\bf Abstraction, $\tm = \lam{\vartwo}{\tmthree}$.}
  In this case $\tmtwo = \lam{\vartwo}{\tmfour}$, where $\tmthree \to \tmfour$.
  Then $\tmtwo'$ must be of the form $\lamp{\lab}{\vartwo}{\tmfour'}$, where $\tmfour' \refines \tmfour$.
  So, using the inductive hypothesis we get that there is a term $\tmthree'$
    such that $\tmthree' \refines \tmthree$ and $\tmthree' \tomulti_\dist \tmfour'$.
  So, if we take $\tm'$ to be $\lamp{\lab}{\vartwo}{\tmthree'}$ we are done.
  \[
  \xymatrix@C=1cm{
    \lam{\vartwo}{\tmthree} \ar@{}[d]|*=0[@]{\rtimes} \ar[r]^{\beta} & \lam{\vartwo}{\tmfour} \ar@{}[d]|*=0[@]{\rtimes} \\
    \lamp{\lab}{\vartwo}{\tmthree'} \ar@{->>}[r]^{\dist} & \lamp{\lab}{\vartwo}{\tmfour'} \\
  }
  \]

\item {\bf Application, $\tm = \tmthree \tmfour$.}
  Here there are three subcases depending on where the redex is.
  \begin{enumerate}
    \item {\bf The redex is in $\tmthree$.} This case is straightforward using the inductive hypothesis, much like the {\bf Abstraction} case.
    \item {\bf The redex is in $\tmfour$.}
      We have that $\tmthree \tmfour \to \tmthree \overline{\tmfour}$,
      and that $\tmtwo' = \tmthree' [\overline{\tmfour}_1, \hdots, \overline{\tmfour}_n]$,
      where $\tmthree' \refines \tmthree$ and $\overline{\tmfour}_i \refines \overline{\tmfour}$.

      Note that for every $i$ we have that $\tmfour \to \overline{\tmfour} \refinedby \overline{\tmfour}_i$,
      so we can use the inductive hypothesis, which tells us that there is a $\tmfour_i$ that refines $\tmfour$
      and reduces to $\overline{\tmfour}_i$.
      So we get what we wanted
      \[
      \xymatrix@C=1cm{
        \tmthree \tmfour \ar@{}[d]|*=0[@]{\rtimes} \ar[r]^{\beta} & \tmthree \overline{\tmfour} \ar@{}[d]|*=0[@]{\rtimes} \\
        \tmthree'[\tmfour_1, \hdots, \tmfour_n] \ar@{->>}[r]^{\dist} & \tmthree'[\overline{\tmfour}_1, \hdots, \overline{\tmfour}_n] \\
      }
      \]
    \item {\bf The redex is at the head.}
      We have that $\tmthree = \lam{\var}{\overline{\tmthree}}$, and
        $\tmthree \tmfour \to \subs{\overline{\tmthree}}{\var}{\tmfour}$.
        As $\tmtwo' \refines \subs{\overline{\tmthree}}{\var}{\tmfour}$,
        by \rlem{refinement_substitution_inverse} we know that
        $\tmtwo' = \subs{\overline{\tmthree}'}{\var}{[\tmfour'_1, \hdots, \tmfour'_n]}$,
        where $\overline{\tmthree}' \refines \overline{\tmthree}$ and $\tmfour'_i \refines \tmfour$.

      Taking $\tm'$ to be $(\lamp{\lab}{\var}{\overline{\tmthree}'})[\tmfour'_1, \hdots, \tmfour'_n]$
      covers our needs, because it reduces to $\tmtwo'$ and refines $\tm$.
  \end{enumerate}
\end{enumerate}
\end{proof}

\begin{proposition}
\lprop{has_hnf_has_refinement}
Let $\tm \in \terms$.
Then $\tm$ has a head normal form if and only if there exists $\tm' \in \termsdist$ such that $\tm \refinedby \tm'$.
\end{proposition}
\begin{proof} We prove both directions separately.
\begin{itemize}
  \item[] {\bf $\Rightarrow$.} If $\tm$ has a head normal form that means that there is a derivation $\tm \rtobeta \tmtwo$ such that $\tmtwo$ is a head normal form.
    As such, by \rlem{hnf_has_refinement}, it has a refinement, which we will call $\tmtwo'$.

    We will prove that if $\tm \rtobeta \tmtwo \refinedby \tmtwo'$ then
    there exists a $\tm'$ that refines $\tm$, and we will proceed by
    induction on the length of the derivation $\tm \rtobeta \tmtwo$.
    Note that this is enough
    \begin{enumerate}
      \item {\bf 0 steps, $\tm = \tmtwo$.} This case is trivial because we take $\tm'$ to be $\tmtwo'$.
      \item {\bf Inductive case, $\tm \rtobeta \tmthree \tobeta \tmtwo$.}
        Using backwards simulation (\rlem{backwards_simulation}), we know that
        there is a term $\tmthree'$ such that $\tmthree' \refines \tmthree$ and $\tmthree' \tomulti_\dist \tmtwo'$.

        Lastly, the inductive hypothesis tells us that there is a $\tm'$ that refines $\tm$.
        Our argument can be summed up in the following diagram,
        where the data labeled with $^1$ are what we know by hypothesis,
        the one labeled with $^2$ is the result of Backwards simulation~(\rlem{backwards_simulation}),
        and the one labeled with $^3$ is given by the inductive hypothesis.

        \[
        \xymatrix@C=1cm{
          \tm  \ar@{}[d]|*=0[@]{\rtimes}^{^3} \ar@{->>}[r]^{\beta^1}
            & \tmthree \ar@{}[d]|*=0[@]{\rtimes}^{^2} \ar[r]^{\beta^1}
            & \tmtwo \ar@{}[d]|*=0[@]{\rtimes}^{^1}  \\
          \tm' & \tmthree' \ar@{->>}[r]^{\dist} & \tmtwo' \\
        }
        \]
    \end{enumerate}
  \item[] {\bf $\Leftarrow$.} Let $\tm'$ such that $\tm' \refines \tm$.
    The term $\tm'$ has a normal form, which is in particular a head normal form.
    \TODO{esto hay que probarlo, pero capaz sale facil}

    We will prove that if $\tm \refinedby \tm' \tomulti_\dist \tmtwo'$ and $\tmtwo'$ is a normal form,
    then there exists a term $\tmtwo$ such that $\tm \rtobeta \tmtwo \refinedby \tmtwo'$.
    Note that this is enough, because if $\tmtwo'$ is in head normal form (as in our case),
    \rlem{hnf_iff_distnf} tells us that $\tmtwo$ is also in head normal form.

    Recall that, in the distributive lambda-calculus,
    the length of derivations starting from a fixed term
    is bounded~(\rcoro{bounded_length_of_derivations})
    as a corollary of the fact that the distributive lambda-calculus
    is strongly normalizing and finitely branching, by K\"onig's lemma.
    We proceed by induction on the length $n$ of the longest derivation going out from $\tm'$.
    \begin{enumerate}
      \item {\bf Base case, $n = 0$.} In this case $\tm' = \tmtwo'$,
        so we can take $\tmtwo$ to be equal to $\tm$ and we are done.
      \item {\bf Induction, $n > 0$.}
        Then there is at least one step:
        \[
        \xymatrix@C=1cm{
          \tm  \ar@{}[d]|*=0[@]{\rtimes}  & &      \\
          \tm' \ar@{->}[r]^{\dist} & \tmthree' \ar@{->>}[r]^{\dist} & \tmtwo' \\
        }
        \]
        Here, reverse simulation (\rprop{reverse_simulation}) tells us that there are $\tmthree$ and $\tmthree''$
        such that:
        \[
        \xymatrix@C=1cm{
          \tm  \ar@{}[d]|*=0[@]{\rtimes} \ar@{->}[rr]^{\beta} & & \tmthree  \ar@{}[d]|*=0[@]{\rtimes} \\
          \tm' \ar@{->}[r]^{\dist} & \tmthree' \ar@{->>}[r]^{\dist} & \tmthree'' \\
        }
        \]
        The longest derivation going out from $\tmthree''$ has $m$ steps.
        Note that $m < n$, for otherwise there would be a derivation $\tm' \todist \tmthree' \rtodist \tmthree'' \rtodist ...$ 
        of more than $n$ steps.

        Furthermore, as $\termsdist$ is confluent~(\rcoro{confluence}) and strongly normalizing~(\rprop{termination}),
        we have that $\tmthree'' \tomulti_\dist \tmtwo'$.
        Since $m < n$, we can use the inductive hypothesis
        on $\tmthree \refinedby \tmthree'' \tomulti_\dist \tmtwo'$, which closes the diagram:
        \[
        \xymatrix@C=1cm{
          \tm  \ar@{}[d]|*=0[@]{\rtimes} \ar@{->}[r]^{\beta} & \tmthree \ar@{}[d]|*=0[@]{\rtimes} \ar@{->>}[r]^{\beta} & \tmtwo \ar@{}[d]|*=0[@]{\rtimes} \\
          \tm' \ar@{->>}[r]^{\dist} & \tmthree'' \ar@{->>}[r]^{\dist} & \tmtwo' \\
        }
        \]
    \end{enumerate}
\end{itemize}
\end{proof}

